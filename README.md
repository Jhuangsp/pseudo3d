# Pseudo3D reconstruction for badminton trajectory

## Contents
1. [Installation](#Installation)
2. [Quick Start Demo](#Quick-Start-Demo)
3. [How to generate synthetic data](#How-to-generate-synthetic-data)
4. [How to get real scene data](#How-to-get-real-scene-data)
5. [Pseudo3D](#Pseudo3D)

## Installation

## Quick Start Demo
For the `synthetic_pseudo3D.py` demo, first point out the 4 corner of the badminton court in order of `left-top`, `right-top`, `right-bottom`, `left-bottom`.
If you want to adjust your corner position, please complete the 4 corner first, then adjust the corner by clicking on the new position. 
The program will find the nearest corner and modify it with new position.
```
# Synthetic monocular visualization
$ python synthetic_pseudo3D.py --json synthetic_track/mono/track.json

# Real-scene monocular visualization
$ python pseudo3D.py --track real_track/CHEN_Long_CHOU_Tien_Chen_Denmark_Open_2019_QuarterFinal/set_1_00_01.csv --height 720 --width 1280
```

## How to generate synthetic data
Generate 1 synthetic image with json pose config
```
$ mkdir mydata
$ cp synthetic_track/mono/track.json mydata/track.json
$ python generator.py --json mydata/track.json --out mydata/ --num 1
```

## How to get real scene data
Our 2D tracking dataset is generated by TrackNetV2 & S2Label, which can download from [Google drive](TODO).
The dataset contains the 2D trajectory predicetion of each rally e.g. `tracknet/1_00_01.csv`, shot-by-shot annotation of each set e.g. `set1.csv` and some hyper-annotation such as rally segmentation `RallySeg.csv` and homography transform matrix `homography_matrix.csv`.


There are some notable things that you should know:
### 1. We are using new format of TrackNetV2 prediction
<table>
<tr><th>Old format </th><th>New format</th></tr>
<tr><td>

| index |   x   |   y   |
| ----- | ----- | ----- |
|   3   |  650  |  266  |
|   4   |  645  |  257  |
|   6   |  640  |  255  |
|   7   |  635  |  252  |
|   8   |  623  |  258  |
|   9   |  615  |  258  |
|  10   |  608  |  261  |

</td><td>

| Frame |   Visibility   |   X   |   Y   |
| ----- | ----- | ----- | ----- |
|   1   |   0   |   0   |   0   |
|   2   |   0   |   0   |   0   |
|   3   |   1   |  650  |  266  |
|   4   |   1   |  645  |  257  |
|   5   |   0   |   0   |   0   |
|   6   |   1   |  640  |  255  |
|   7   |   1   |  635  |  252  |

</td></tr> </table>

Use the `Rearrange_Label.py` to transform old format to new format.
```
# Usage: python Rearrange_Label.py <inputPath> <outputPath> <segFile>

$ cd real_track
$ mkdir new_format
$ python Rearrange_Label.py CHEN_Long_CHOU_Tien_Chen_Denmark_Open_2019_QuarterFinal/format_old/ new_format/ CHEN_Long_CHOU_Tien_Chen_Denmark_Open_2019_QuarterFinal/RallySeg.csv
```

### 2. Associate TrackNetV2 prediction to shot-by-shot annotation
We change the original rally-based indexing to set-based indexing, and add the hit event attributes which mark the frame as `Hit=True`, (`StartX`, `StartY`) and (`EndX`, `EndY`) as the anchor points of start/end of shot.
<table>
<tr><th>New format </th><th>New format associate with S2 annotation</th></tr>
<tr><td>

| Frame |   Visibility   |   X   |   Y   |
| ----- | ----- | ----- | ----- |
|   1   |   0   |   0   |   0   |
|   2   |   0   |   0   |   0   |
|   3   |   1   |  650  |  266  |
|   4   |   1   |  645  |  257  |
|   5   |   0   |   0   |   0   |
|   6   |   1   |  640  |  255  |
|   7   |   1   |  635  |  252  |

</td><td>

| Frame |   Visibility   |   X   |   Y   | Hit | StartX | StartY | EndX | EndY |
| ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- |
| 10452 |   0   |   0   |   0   | False | (None) | (None) | (None) | (None) |
| 10453 |   0   |   0   |   0   | False | (None) | (None) | (None) | (None) |
| 10454 |   1   |  650  |  266  | True | (None) | (None) | 568.0 | 328.0 |
| 10455 |   1   |  645  |  257  | False | (None) | (None) | (None) | (None) |
| 10456 |   0   |   0   |   0   | False | (None) | (None) | (None) | (None) |
| 10457 |   1   |  640  |  255  | False | (None) | (None) | (None) | (None) |
| 10458 |   1   |  635  |  252  | True | 568.0 | 328.0 | 828.0 | 580.0 |
</td></tr> </table>

 - Note that #10454 frame is the serve frame, which doesn't label the start anchor point of the serve shot.

Use the `rallyMatcher.py` to associate annotation.
```
# Usage: python rallyMatcher.py --rally <RALLY_FOLDER> --set <SET_FILE> --seg <SEGMENT_FILE> --out <OUTPUT_FOLDER>

$ cd real_track
$ mkdir associated
$ python rallyMatcher.py --rally CHEN_Long_CHOU_Tien_Chen_Denmark_Open_2019_QuarterFinal/format_new --set CHEN_Long_CHOU_Tien_Chen_Denmark_Open_2019_QuarterFinal/set1.csv --seg CHEN_Long_CHOU_Tien_Chen_Denmark_Open_2019_QuarterFinal/RallySeg.csv --out associated
```

## Pseudo3D